#!/usr/bin/env sh

# Exit if any subcommand fails
set -e

# set up environment variables
cp .sample.env .env

# Set up phoenix
mix local.hex --force
mix deps.get
mix deps.compile
mix compile

# Set up database
mix ecto.create
mix ecto.migrate

# Grab JS dependencies from NPM
npm install

# Only if this isn't CI
if [ -z "$CI" ]; then
  # Set up Heroku
  heroku join --app constable-api-staging
  heroku git:remote -r staging -a constable-api-staging

  heroku join --app constable-api-production
  heroku git:remote -r production -a constable-api-production
fi

echo "Get the CLIENT_ID and CLIENT_SECRET from the constable-api-staging app on Heroku and put it in your .env"
